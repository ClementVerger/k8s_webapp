name: CI CD - k8s Webapp

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Variables globales (rÃ©utilisables dans les steps)
env:
  REGISTRY: docker.io
  BACKEND_IMAGE_NAME: k8s-webapp-backend
  FRONTEND_IMAGE_NAME: k8s-webapp-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # Secrets Docker disponibles dans tous les steps de ce job
    env:
      DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}

    # Ce que ce job expose au job "deploy"
    outputs:
      BACKEND_IMAGE_TAG: ${{ steps.images.outputs.BACKEND_IMAGE_TAG }}
      FRONTEND_IMAGE_TAG: ${{ steps.images.outputs.FRONTEND_IMAGE_TAG }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define dynamic image names
        id: vars
        run: |
          echo "BACKEND_IMAGE=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}" >> $GITHUB_OUTPUT
          echo "FRONTEND_IMAGE=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}" >> $GITHUB_OUTPUT

      - name: Install backend dependencies
        working-directory: backend
        run: |
          npm install

      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          npm install
          npm run lint || true

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_PASS }}

      - name: Build and push backend image
        working-directory: backend
        run: |
          TAG=${{ github.sha }}
          IMAGE="${{ steps.vars.outputs.BACKEND_IMAGE }}"
          echo "Building backend image: $IMAGE:$TAG"
          docker build -t $IMAGE:$TAG .
          docker push $IMAGE:$TAG

      - name: Build and push frontend image
        working-directory: frontend
        run: |
          TAG=${{ github.sha }}
          IMAGE="${{ steps.vars.outputs.FRONTEND_IMAGE }}"
          echo "Building frontend image: $IMAGE:$TAG"
          docker build -t $IMAGE:$TAG .
          docker push $IMAGE:$TAG

      - name: Export image tags for next job
        id: images
        run: |
          echo "BACKEND_IMAGE_TAG=${{ steps.vars.outputs.BACKEND_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "FRONTEND_IMAGE_TAG=${{ steps.vars.outputs.FRONTEND_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    needs: build-and-push
    runs-on: self-hosted 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update images in manifests
        run: |
          BACKEND_IMAGE_TAG="${{ needs.build-and-push.outputs.BACKEND_IMAGE_TAG }}"
          FRONTEND_IMAGE_TAG="${{ needs.build-and-push.outputs.FRONTEND_IMAGE_TAG }}"

          echo "Using backend image: $BACKEND_IMAGE_TAG"
          echo "Using frontend image: $FRONTEND_IMAGE_TAG"

          sed -i "s|image: clementvrg/k8s-webapp-backend:.*|image: ${BACKEND_IMAGE_TAG}|" k8s/deployment/backend-deployment.yaml
          sed -i "s|image: clementvrg/k8s-webapp-frontend:.*|image: ${FRONTEND_IMAGE_TAG}|" k8s/deployment/frontend-deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/ -n k8s-webapp

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n k8s-webapp
          kubectl rollout status deployment/frontend -n k8s-webapp
